plugins {
    id 'java-platform'
    id 'maven-publish'
}
def ENV = System.getenv()

allprojects {
    def buildNumber = ENV.TRAVIS_BUILD_NUMBER
    version = "${project.api_version}.${buildNumber ?: "0"}"
    group = project.maven_group
}

archivesBaseName='platform'

void addRepo(RepositoryHandler repositories) {
    def ENV = System.getenv()
    if (ENV.mvn_username) {
        repositories.maven {
            name = "Maven"
            url = uri("sftp://maven.sandboxpowered.org:22/sbxmvn/")
            credentials {
                username = ENV.mvn_username
                password = ENV.mvn_password
            }
        }
    }
}

subprojects {
    apply plugin: 'java-library'
    apply plugin: 'maven-publish'

    repositories {
        mavenCentral()
        maven { url 'https://jitpack.io' }
        maven { url 'https://maven.sandboxpowered.org' }
    }

    if (project.name != "base") {
        dependencies {
            api project(':base')
        }
    }

    publishing {
        publications {
            mavenJava(MavenPublication) {
                afterEvaluate {
                    artifact jar
                }
            }
        }
        addRepo(repositories)
    }
}

dependencies {
    constraints {
        api project(":base")
        api project(":rendering")
        api project(":rendering-opengl")
        api project(":rendering-vulkan")
    }
}

publishing {
    publications {
        platform(MavenPublication) {
            groupId = project.maven_group
            artifactId = 'api'

            from components.javaPlatform
        }
    }
    addRepo(repositories)
}