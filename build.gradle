buildscript {
    repositories {
        maven {
            url "https://plugins.gradle.org/m2/"
        }
    }
    dependencies {
        classpath "org.javamodularity:moduleplugin:1.6.0"
    }
}

plugins {
    id 'java-platform'
    id 'maven-publish'
}
def ENV = System.getenv()

allprojects {
    def buildNumber = ENV.BUILD_NUMBER
    version = "${project.api_version}.${buildNumber ?: "0"}"
    group = project.maven_group
}

archivesBaseName='platform'

void addRepo(RepositoryHandler repositories) {
    def ENV = System.getenv()
    if (ENV.mvn_username) {
        repositories.maven {
            name = "Maven"
            url = uri("sftp://maven.sandboxpowered.org:22/sbxmvn/")
            credentials {
                username = ENV.mvn_username
                password = ENV.mvn_password
            }
        }
    }
}

subprojects {
    apply plugin: 'java-library'
    apply plugin: 'maven-publish'
    apply plugin: 'org.javamodularity.moduleplugin'

    sourceCompatibility = targetCompatibility = JavaVersion.VERSION_11

    repositories {
        mavenCentral()
        maven { url 'https://jitpack.io' }
        maven { url 'https://maven.sandboxpowered.org' }
    }

    if (project.name != "base") {
        dependencies {
            api project(':base')
        }
    }

    publishing {
        publications {
            mavenJava(MavenPublication) {
                afterEvaluate {
                    artifact jar
                }
            }
        }
        addRepo(repositories)
    }
}

dependencies {
    constraints {
        api project(":base")
        api project(":rendering")
        api project(":rendering-opengl")
        api project(":rendering-vulkan")

        api project(":resources")
    }
}

publishing {
    publications {
        platform(MavenPublication) {
            groupId = project.maven_group
            artifactId = 'api'

            from components.javaPlatform
        }
    }
    addRepo(repositories)
}